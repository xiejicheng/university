## LVS 负载均衡



### 四七层负载定义

**概念定义：**

- 四层：基于 IP + 端口的负载均衡（传输层）
- 七层：基于应用层（URL）信息的负载均衡

> 四层负载只需经过内核空间，七层负载需要转发到用户空间。

**适用场景：**

|       四层        |        七层        |
| :---------------: | :----------------: |
|     大型站点      |      中小站点      |
|   接入层最前端    |                    |
| 结合四层+七层使用 | 只使用七层负载均衡 |

**优缺点：**

- 四层比七层可以承载更大的并发量，适用大型站点
- 七层可以实现更为复杂的负载均衡控制，比如基于 URL 、基于 Session 、动静分离等
- 七层会占用大量 CPU 时间，承载的并发量小
- 七层的配置复杂，四层的相对简单



### LVS 原理及常见模型

##### LVS 定义

- LVS 全称 Linux Virtual Server，是一个虚拟的服务器集群系统
- 章文嵩博士主导的开源负载均衡项目，目前 LVS 已经被集成到 linux 内核模块中

##### LVS 组成

- Ipvs：工作在 `内核空间` ，实现集群服务的调度，借鉴了 iptables 实现
- Ipvsadm：工作在 `用户空间` ，复杂为 ipvs 内核框架编写规则，定义谁是集群服务，谁是后端服务器



![lvs工作原理](https://github.com/xiejicheng/university/blob/master/img/lvs工作原理.png)



#### LVS 相关术语

- **DS**     Director Server     目标服务器，即负载均衡器
- **RS**     Real Server            真实服务器，即后端服务器
- **VIP**    Virtual IP                直接面向用户的 IP 地址，通常为公网 IP 地址
- **DIP**   Director Server IP  主要用于和内部主机通信的 IP 地址
- **CIP**    Client IP                  访问客户端的IP地址。
- **RIP**     Read Server IP      后端真实服务器的 IP 地址              



#### LVS 的类型

- **NAT**：修改目标 IP 地址为后端的 Real Server 的 IP 地址
- **DR**：  修改目标 MAC 地址为后端的 Real Server 的 MAC 地址 ⭐
- TUNNEL：较少使用，常用于异地容灾



### LVS NAT 模型的原理

NAT：Network Address Translation  **网络地址转换**

**LVS NAT：** 修改目标 IP 地址为挑选出新的 RS 的 IP 地址。即请求进入负载均衡器时做 DNAT，响应出负载均衡器时做 SNAT

> DNAT：修改目的IP地址从A变B，使得发送方以为自己发送给了A，实际上是发送给了B

>SNAT：修改源IP地址从A变成B，使得接收方以为发送的主机是B而不是A

**SNAT** 是指在数据包从网卡发送出去的时候，把数据包中的源地址部分替换为指定的IP，这样，接收方就认为数据包的来源是被替换的那个IP的主机。

**DNAT** 就是指数据包从网卡发送出去的时候，修改数据包中的目的IP，表现为如果你想访问A，可是因为网关做了DNAT，把所有访问A的数据包的目的IP全部修改为B，那么，你实际上访问的是B。

![lvs-nat](https://github.com/xiejicheng/university/blob/master/img/lvs-nat.png)

 

#### LVS NAT 的特性

- RS 必须使用私有地址，并且将网关指向 DS 的 DIP 
- RIP 和 DIP 必须为同一网段内
- 支持端口映射
- RS 可以使用任意操作系统
- 请求与相应报文都要经过 DS，高负载场景中，DS 容易成为瓶颈  ❗



#### Ipvsadm 工具

- LVS 是依靠 ipvs 在内核生成一系列规则工作的
- Ipvsadm 是在用户空间管理 ipvs 规则的命令行工具

#### Ipvsadm 用法介绍

**集群服务相关**

- `-A`     添加集群服务
- `-E`     修改集群服务
- `-D`     删除集群服务
- `-s`     指定调度算法，例如rr、wrr、lc、wlc 等

**RS 相关**

- `-a`     向指定的集群服务添加 RS
- `-r`     指定 RS 的 IP 地址，包含 `IP:PORT`

- `-g`|`-i`|`-m`      指定 LVS 类型，分别是 `DR`|`TUN`|`NAT`
- `-w`      指定 RS 的权重

- `-e`      修改指定的 RS 属性（ip地址、端口号等等）

- `-d`       删除 RS

**管理相关**

- `-C`     清空集群服务
- `-L`     查看 IPVS 规则

- `-Z`     计数器清零

- `-S`     使用 ipvsadm -S 保存规则至磁盘

- `-R`     使用 ipvsadm -R 从磁盘载入规则



### LVS 八种调度算法

#### 1.轮询算法 rr

轮询算法，它将请求依次分配给不同的rs节点，也就是RS节点中均摊分配。调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。这种算法简单，但只适合于RS节点处理性能差不多的情况。

#### 2.加权轮询 wrr

这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加要给权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。它将依据不同RS的权值分配任务。权值较高的RS将优先获得任务，并且分配到的连接数将比权值低的RS更多。相同权值的RS得到相同数目的连接数。

#### 3.最少链接 lc

最小连接数调度（least-connection）,IPVS表存储了所有活动的连接。LB会比较将连接请求发送到当前连接最少的RS。这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1

#### 4.加权最少链接 wlc

这个算法比 lc 多了一个权重的概念。加权最小连接数调度，假设各台RS的全职依次为Wi，当前tcp连接数依次为Ti，依次去Ti/Wi为最小的RS作为下一个分配的RS。

#### 5.基于局部性的最少连接调度算法 lblc

这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器

#### 6.复杂的基于局部性最少的连接算法 lblcr

记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。

#### 7.目标地址散列调度算法 dh

该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。

#### 8.源地址散列调度算法 sh

与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。
